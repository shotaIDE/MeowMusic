import '../android/fastlane/Fastfile'
import '../ios/fastlane/Fastfile'

require 'yaml'

desc 'Get Flutter dependencies'
lane :install_flutter_dependencies do
  sh('flutter pub get --no-example')
end

desc 'Generate automatic codes'
lane :generate do
  install_flutter_dependencies
  sh('flutter pub run build_runner build --delete-conflicting-outputs')
end

desc 'Bump patch version'
lane :bump_patch_version do
  Dir.chdir('../') do
    sh('dart run cider bump patch --bump-build')
  end
end

private_lane :get_version_code do
  pubspec = Dir.chdir('../') do
    YAML.load_file('./pubspec.yaml')
  end
  current_version_full_text = pubspec['version']

  matched = /^\d+\.\d+\.\d+\+(\d+)$/.match(current_version_full_text)

  version_code = matched[1].to_i
  version_code
end
